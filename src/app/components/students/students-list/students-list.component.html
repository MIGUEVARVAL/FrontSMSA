<main class="body">

    <div class="row m-0">
        <div class="col-12 col-lg-2">

            <form [formGroup]="filterForm" (ngSubmit)="filterStudents()">

                <div class="filter">
                    <div class="d-flex flex-column gap-4">

                        <div class="d-flex flex-column gap-3">
                            <h3 class="text-neutral-30 d-flex align-items-center gap-2">
                                <span class="material-symbols-outlined">filter_alt</span>
                                Filtrar búsqueda
                            </h3>
                            <div class="d-flex flex-column gap-2">
                                <p class="text-neutral-30">{{estudiantesListResponse.count}} estudiantes</p>

                            </div>
                        </div>

                        <div class="text-truncate">
                            <div class="d-flex flex-wrap gap-2">
                                @if (filtrosActivos.documento) {
                                <p class="tag tag-tertiary-blue">
                                    Documento: {{ filtrosActivos.documento }}
                                </p>
                                }
                                @if (filtrosActivos.login) {
                                <p class="tag tag-tertiary-blue">
                                    Usuario: {{ filtrosActivos.login }}
                                </p>
                                }
                                @if (filtrosActivos.nombres) {
                                <p class="tag tag-tertiary-blue">
                                    Nombres: {{ filtrosActivos.nombres }}
                                </p>
                                }
                                @if (filtrosActivos.apellidos) {
                                <p class="tag tag-tertiary-blue">
                                    Apellidos: {{ filtrosActivos.apellidos }}
                                </p>
                                }
                                @if (filtrosActivos.papaMin) {
                                <p class="tag tag-tertiary-blue">
                                    P.A.P.A. Mín: {{ filtrosActivos.papaMin }}
                                </p>
                                }
                                @if (filtrosActivos.papaMax && filtrosActivos.papaMax < 5) { <p
                                    class="tag tag-tertiary-blue">
                                    P.A.P.A. Máx: {{ filtrosActivos.papaMax }}
                                    </p>
                                    }
                                    @if (filtrosActivos.avanceMin ) {
                                    <p class="tag tag-tertiary-blue">
                                        Avance Mín: {{ filtrosActivos.avanceMin }}%
                                    </p>
                                    }
                                    @if (filtrosActivos.avanceMax && filtrosActivos.avanceMax < 100) { <p
                                        class="tag tag-tertiary-blue">
                                        Avance Máx: {{ filtrosActivos.avanceMax }}%
                                        </p>
                                        }
                                        @if (filtrosActivos.programa) {
                                        <p class="tag tag-tertiary-blue">
                                            Programa: {{ filtrosActivos.programa }}
                                        </p>
                                        }
                                        @if (filtrosActivos.activo) {
                                        <p class="tag tag-tertiary-blue">
                                            Estado: {{ filtrosActivos.activo ? 'Activo' : 'Inactivo' }}
                                        </p>
                                        }
                                        @if (filtrosActivos.matriculas) {
                                        <p class="tag tag-tertiary-blue">
                                            Matrículas: {{ filtrosActivos.matriculas }}
                                        </p>
                                        }
                                        @if (filtrosActivos.acceso) {
                                        <p class="tag tag-tertiary-blue">
                                            Acceso: {{ filtrosActivos.acceso }}
                                        </p>
                                        }
                                        @if (filtrosActivos.subacceso) {
                                        <p class="tag tag-tertiary-blue">
                                            Subacceso: {{ filtrosActivos.subacceso }}
                                        </p>
                                        }
                                        @if (filtrosActivos.orderBy) {
                                        <p class="tag tag-tertiary-blue">
                                            Ordenado por: {{ filtrosActivos.orderBy }}
                                        </p>
                                        }
                                        @if (filtrosActivos.orderDirection) {
                                        <p class="tag tag-tertiary-blue">
                                            Orden: {{ filtrosActivos.orderDirection === 'ASC' ? 'Ascendente' :
                                            'Descendente' }}
                                        </p>
                                        }
                            </div>
                        </div>

                        <div>
                            <button class="btn btn-link-primary fw-black" type="reset" (click)="clearFilters()">
                                <span>Limpiar todos los filtros</span>
                                <span class="material-symbols-outlined icon">delete</span>
                            </button>
                        </div>
                    </div>

                    <div>
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" id="riesgo" formControlName="riesgo"
                                (click)="filterStudents()" />
                            <label class="form-check-label">Solo estudiantes en riesgo</label>
                        </div>
                    </div>
                    <div class="d-flex flex-column gap-1">
                        <div class="d-flex flex-column gap-3">
                            <div class="row row-cols-1 row-cols-md-2">
                                <div>
                                    <label for="ordenar" class="form-label">Ordenar por</label>
                                    <select id="ordenar" class="form-select" formControlName="orderBy">
                                        <option value="" selected>Seleccione</option>
                                        <option value="nombres">Nombre completo</option>
                                        <option value="avance_carrera">Avance</option>
                                        <option value="papa">P.A.P.A.</option>
                                        <option value="creditos_disponibles">Créditos Disponibles</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="orden" class="form-label">Orden</label>
                                    <select id="orden" class="form-select" formControlName="orderDirection">
                                        <option value="" selected>Seleccione</option>
                                        <option value="ASC" selected>Ascendente</option>
                                        <option value="DESC">Descendente</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row row-cols-1 row-cols-md-2">
                                <div>
                                    <label for="documento" class="form-label">Documento</label>
                                    <input type="text" class="form-control" id="documento" placeholder="12345"
                                        formControlName="documento" />
                                </div>
                                <div>
                                    <label for="login" class="form-label">Usuario</label>
                                    <input type="text" class="form-control" id="login" placeholder="mivargasv"
                                        formControlName="login" />
                                </div>

                            </div>
                            <div class="row row-cols-1 row-cols-md-2">
                                <div>
                                    <label for="nombres" class="form-label">Nombres</label>
                                    <input type="text" class="form-control" id="nombres" placeholder="Miguel"
                                        formControlName="nombres" />
                                </div>

                                <div>
                                    <label for="apellidos" class="form-label">Apellidos</label>
                                    <input type="text" class="form-control" id="apellidos" placeholder="Vargas"
                                        formControlName="apellidos" />
                                </div>
                            </div>

                            <div>
                                <label class="form-label">P.A.P.A.</label>

                                <div class="row row-cols-1 row-cols-md-2">
                                    <div>
                                        <div class="input-group form-range" bs-range>
                                            <label for="papaMin" class="form-label">Mínimo</label>
                                            <input class="form-control" type="range" formControlName="papaMin" value="0"
                                                min="0" max="5" step="0.1" />

                                        </div>
                                    </div>
                                    <div>
                                        <div class="input-group form-range" bs-range>
                                            <label for="papaMax" class="form-label">Máximo</label>
                                            <input class="form-control" type="range" formControlName="papaMax" value="5"
                                                min="0" max="5" step="0.1" />
                                        </div>
                                    </div>
                                </div>

                            </div>


                            <div>
                                <label class="form-label">Avance Carrera</label>

                                <div class="row row-cols-1 row-cols-md-2">
                                    <div>
                                        <div class="input-group form-range" bs-range>
                                            <label for="avanceMin" class="form-label">Mínimo</label>
                                            <input class="form-control" type="range" formControlName="avanceMin"
                                                value="0" min="0" max="100" step="1" />
                                        </div>
                                    </div>

                                    <div>
                                        <div class="input-group form-range" bs-range>
                                            <label for="avanceMax" class="form-label">Máximo</label>
                                            <input class="form-control" type="range" formControlName="avanceMax"
                                                value="100" min="0" max="100" step="1" />
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div>
                                <label for="programa" class="form-label">Programa</label>
                                <input type="text" class="form-control" id="programa" placeholder="Ingeni.."
                                    formControlName="programa" />
                            </div>
                            <div class="row row-cols-1 row-cols-md-2">
                                <div>
                                    <label for="activo" class="form-label">Estado</label>
                                    <select id="activo" class="form-select" formControlName="activo">
                                        <option [value]="true">Activo</option>
                                        <option [value]="false">Inactivo</option>
                                    </select>
                                </div>

                                <div>
                                    <label for="matriculas" class="form-label">Matriculas</label>
                                    <input type="number" class="form-control" id="matriculas" placeholder="2"
                                        formControlName="matriculas" />
                                </div>
                            </div>
                            <div>
                                <label for="acceso" class="form-label">Acceso</label>
                                <input type="text" class="form-control" id="acceso" placeholder="Examen.."
                                    formControlName="acceso" />
                            </div>
                            <div>
                                <label for="subacceso" class="form-label">Subacceso</label>
                                <input type="text" class="form-control" id="subacceso" placeholder="Regular.."
                                    formControlName="subacceso" />
                            </div>


                        </div>

                    </div>

                    <div class="d-flex flex-column gap-4">
                        <button class="btn btn-primary" type="submit">
                            <span class="material-symbols-outlined">filter_alt</span>
                            <span>Filtrar</span>
                        </button>
                    </div>
                </div>
            </form>

        </div>

        <div class="col d-flex flex-column gap-3">

            <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a routerLink="/home">Inicio</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Listado de estudiantes</li>
                </ol>
            </nav>

            <div class="p-5 mx-2 bg-neutral-95">

                <h2 class="text-neutral-30 text-center my-2">Listado de Estudiantes</h2>

                <hr class="hr my-4">

                <app-messages></app-messages>

                @if (estudiantesListResponse.results.length === 0) {
                <div
                    class="bg-neutral-variant-99 border-neutral-variant-80 border-2 border w-100 rounded-5 text-center p-4">
                    <h4 class="text-neutral-variant">No se encontraron estudiantes</h4>
                    <p class="text-neutral-variant-50">Revise que si se hayan cargado correctamente o comuníquese con el
                        administrador.</p>
                </div>
                } @else {

                <div class="vstack gap-4">

                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Nombre completo</th>
                                    <th>Avance</th>
                                    <th>P.A.P.A.</th>
                                    <th>Créditos Disponibles</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="table-group-divider">

                                @for (estudiante of estudiantesListResponse.results; track $index) {
                                <tr>
                                    <td>
                                        <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" attr.data-bs-target="#collapse{{ estudiante.id }}"
                                            aria-expanded="true" attr.aria-controls="collapse{{ estudiante.id }}">
                                        </button>
                                    </td>
                                    <td>{{estudiante.nombres}} {{estudiante.apellidos}}</td>
                                    <td>{{estudiante.avance_carrera}}</td>
                                    @if(estudiante.papa){
                                    <td [ngClass]="{'fw-bold': estudiante.papa <= 3.2}">
                                        @if (estudiante.papa <= 3.2) { 
                                            <div class="toolbar sm bg-fixed-warning" role="group"
                                                aria-label="Basic example">
                                                {{ estudiante.papa }}
                                            </div>
                                            }
                                            @else {
                                            {{ estudiante.papa }}
                                            }
                                    </td>
                                    }@else {
                                    <td>
                                        Sin información
                                    </td>
                                    }
                                    @if(estudiante.creditos_disponibles){
                                    <td [ngClass]="{'fw-bold': estudiante.creditos_disponibles <= 10}">
                                        @if (estudiante.creditos_disponibles <= 10) { 
                                            <div class="toolbar sm bg-fixed-warning" role="group"
                                                aria-label="Basic example">
                                                {{ estudiante.creditos_disponibles }}
                                            </div>
                                            } @else {
                                                <div>
                                                    {{ estudiante.creditos_disponibles }}
                                                </div>
                                            }
                                    </td>
                                    }@else {
                                    <td>
                                        Sin información
                                    </td>
                                    }
                                    <td>
                                        @if (estudiante.activo) {
                                        <button class="tag tag-success">Activo</button>

                                        } @else {
                                        <button class="tag tag-neutral">Inactivo</button>
                                        }
                                    </td>

                                    <td>
                                        <div class="toolbar sm bg-fixed-primary" role="group"
                                            aria-label="Basic example">
                                            <a type="button" class="btn btn-icon" data-bs-toggle="tooltip"
                                                data-bs-title="Añadir" (click)="addStudentToActive(estudiante.id!)">
                                                <span class='material-symbols-fill'>visibility</span>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="collapse-row">
                                    <td colspan="7" class="accordion-item">
                                        <div id="collapse{{estudiante.id}}" class="accordion-collapse collapse"
                                            data-bs-parent="#accordionExample0">
                                            <div class="accordion-body row row-cols-1 g-4">
                                                <div class="col">
                                                    <dl>
                                                        <div class="row m-0 py-4 border-top border-neutral-80">
                                                            <dt class="col-12 col-lg-4 text-neutral-10 text-truncate">
                                                                Tipo de identificación</dt>
                                                            <dd class="col-12 col-lg-8 text-neutral-30">
                                                                {{ estudiante.tipo_documento }}</dd>
                                                        </div>

                                                        <div class="row m-0 py-4 border-top border-neutral-80">
                                                            <dt class="col-12 col-lg-4 text-neutral-10">Número de
                                                                identificación</dt>
                                                            <dd class="col-12 col-lg-8 text-neutral-30">{{
                                                                estudiante.documento }}
                                                            </dd>
                                                        </div>

                                                        <div class="row m-0 py-4 border-top border-neutral-80">
                                                            <dt class="col-12 col-lg-4 text-neutral-10">Correo
                                                                electrónico</dt>
                                                            <dd class="col-12 col-lg-8 text-neutral-30">
                                                                {{ estudiante.correo_institucional }}</dd>
                                                        </div>

                                                        <div class="row m-0 py-4 border-top border-neutral-80">
                                                            <dt class="col-12 col-lg-4 text-neutral-10">Plan
                                                            </dt>
                                                            <dd class="col-12 col-lg-8 text-neutral-30">
                                                                {{ estudiante.plan_estudio.codigo }} - {{
                                                                estudiante.plan_estudio.nombre }}</dd>
                                                        </div>

                                                        <div class="row m-0 py-4 border-top border-neutral-80">
                                                            <dt class="col-12 col-lg-4 text-neutral-10">Acceso
                                                            </dt>
                                                            <dd class="col-12 col-lg-8 text-neutral-30">
                                                                {{ estudiante.acceso }}</dd>
                                                        </div>
                                                    </dl>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                }

                            </tbody>


                        </table>
                    </div>
                </div>

                <div class="d-flex flex-column flex-md-row gap-2 justify-content-center align-items-center mt-5">
                    <p class="flex-grow-1">
                        Página {{ page }} de {{ totalPages }}
                    </p>
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-neutral">

                            <li class="page-item" [class.disabled]="page === 1">
                                <a class="page-link" (click)="onPageChange(1)" aria-label="Primera">&laquo;</a>
                            </li>
                            <li class="page-item" [class.disabled]="page === 1">
                                <a class="page-link" (click)="onPageChange(page - 1)" aria-label="Anterior">&lsaquo;</a>
                            </li>

                            <!-- Primera página -->
                            <li class="page-item" [class.active]="page === 1">
                                <a class="page-link" (click)="onPageChange(1)">1</a>
                            </li>

                            <!-- Puntos suspensivos a la izquierda -->
                            @if (page > 3) {
                            <li class="page-item"><a class="page-link" aria-label="more"></a></li>
                            }

                            <!-- Página anterior -->
                            @if (page > 2) {
                            <li class="page-item" [class.active]="false">
                                <a class="page-link" (click)="onPageChange(page - 1)">{{ page - 1 }}</a>
                            </li>
                            }

                            <!-- Página actual (si no es la primera ni la última) -->
                            @if (page !== 1 && page !== totalPages) {
                            <li class="page-item" [class.active]="true">
                                <a class="page-link" (click)="onPageChange(page)">{{ page }}</a>
                            </li>
                            }

                            <!-- Página siguiente -->
                            @if (page < totalPages - 1) { <li class="page-item" [class.active]="false">
                                <a class="page-link" (click)="onPageChange(page + 1)">{{ page + 1 }}</a>
                                </li>
                                }

                                <!-- Puntos suspensivos a la derecha -->
                                @if (page < totalPages - 2) { <li class="page-item"><a class="page-link"
                                        aria-label="more"></a></li>
                                    }

                                    <!-- Última página (si hay más de una) -->
                                    @if (totalPages > 1) {
                                    <li class="page-item" [class.active]="page === totalPages">
                                        <a class="page-link" (click)="onPageChange(totalPages)">{{ totalPages }}</a>
                                    </li>
                                    }

                                    <li class="page-item" [class.disabled]="page === totalPages">
                                        <a class="page-link" (click)="onPageChange(page + 1)"
                                            aria-label="Siguiente">&rsaquo;</a>
                                    </li>
                                    <li class="page-item" [class.disabled]="page === totalPages">
                                        <a class="page-link" (click)="onPageChange(totalPages)"
                                            aria-label="Última">&raquo;</a>
                                    </li>
                        </ul>
                    </nav>
                </div>
                }
            </div>
        </div>

    </div>
</main>

@if (isLoading) {
<app-loading></app-loading>
}